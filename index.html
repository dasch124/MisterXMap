<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Wien Quadrant 100 m (2 km südlich, Label sichtbar)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; }
    #map { height:100vh; width:100%; }
    #quadrant-display {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.9);
      padding:10px 20px;
      font-size:22px;
      font-weight:bold;
      border-radius:10px;
      z-index:1000;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
    }
    .quadrant-label {
      font-weight:bold;
      color:#222;
      background:rgba(255,255,0,0.8);
      border-radius:6px;
      padding:2px 6px;
      font-size:16px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div id="quadrant-display">Quadrant: ?</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([48.192,16.395], 17); // ca. 2 km südlich von Wien 10
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    const quadrantDisplay = document.getElementById('quadrant-display');

    // Rasterparameter
    const deltaLat = 0.01802; // 2 km südlich
    const baseLat = 48.192 - deltaLat;
    const baseLng = 16.375;
    const metersToDegLat = 100 / 111000;  // 100 m
    const metersToDegLng = metersToDegLat / Math.cos(48.2 * Math.PI / 180);

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let highlightedRect = null;
    let labelMarker = null;

    function getQuadrant(lat, lng) {
      const row = Math.floor((lat - baseLat) / metersToDegLat);
      const col = Math.floor((lng - baseLng) / metersToDegLng);
      if (row < 0 || col < 0) return null;
      const latMin = baseLat + row * metersToDegLat;
      const lngMin = baseLng + col * metersToDegLng;
      const label = letters[row % letters.length] + (col + 1);
      return {latMin, latMax: latMin + metersToDegLat, lngMin, lngMax: lngMin + metersToDegLng, label};
    }

    function highlightQuadrant(lat, lng) {
      const q = getQuadrant(lat, lng);
      if (!q) {
        quadrantDisplay.textContent = "Quadrant: außerhalb";
        if (highlightedRect) { map.removeLayer(highlightedRect); highlightedRect=null; }
        if (labelMarker) { map.removeLayer(labelMarker); labelMarker=null; }
        return;
      }

      quadrantDisplay.textContent = "Quadrant: " + q.label;

      if (highlightedRect) map.removeLayer(highlightedRect);
      highlightedRect = L.rectangle([[q.latMin, q.lngMin], [q.latMax, q.lngMax]], {
        color:'yellow', weight:2, fillOpacity:0.25
      }).addTo(map);

      const centerLat = (q.latMin + q.latMax)/2;
      const centerLng = (q.lngMin + q.lngMax)/2;

      if (labelMarker) map.removeLayer(labelMarker);
      labelMarker = L.marker([centerLat, centerLng], {
        icon: L.divIcon({
          className:'quadrant-label',
          html:q.label,
          iconSize:[40,20],
          iconAnchor:[20,10]
        })
      }).addTo(map);
    }

    // GPS-Tracking
    function startTracking() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          highlightQuadrant(lat, lng);

          if (!window.userMarker) {
            window.userMarker = L.marker([lat, lng]).addTo(map);
            window.userCircle = L.circle([lat, lng], {radius:pos.coords.accuracy}).addTo(map);
          } else {
            window.userMarker.setLatLng([lat, lng]);
            window.userCircle.setLatLng([lat, lng]).setRadius(pos.coords.accuracy);
          }
        }, err => {
          console.warn("GPS nicht verfügbar → Testkoordinaten");
          highlightQuadrant(48.192,16.395);
        }, {enableHighAccuracy:true, maximumAge:1000, timeout:5000});
      } else {
        highlightQuadrant(48.192,16.395);
      }
    }

    startTracking();
  </script>
</body>
</html>
